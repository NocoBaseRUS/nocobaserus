# 节点类型

节点是工作流中逻辑编排的基本单元，一个工作流可以配置任意多个节点，每个节点都包含一个指令，即节点的类型，节点的类型决定了节点的行为。节点的配置即对应指令的参数，参数决定其行为的操作数据对象或其他内容。

注：工作流的触发器不属于节点，只是以入口节点的形式展示在流程图中，但与节点是不同的概念，详情请参考[触发器](./triggers.md)的内容。

从功能角度，目前已实现的节点可以分为四大类（共 13 种节点）：

* [流程控制类](#流程控制类)
    * 条件判断
    * 并行分支
    * 循环
    * 延时
    * 运算
* 数据表操作
    * 新增数据
    * 更新数据
    * 删除数据
    * 查询数据
    * 聚合查询
    * SQL 操作
* 人工处理
    * 人工处理
* 外部调用
    * HTTP 请求

## 流程控制类

### 条件判断

类型于编程语言中的 `if` 语句，根据配置条件判断的结果，决定后续流程的走向。

#### 基本使用

条件判断有两种模式，分别是“‘是’则继续”和“‘是’和‘否’分别继续”，在创建节点时需要选择其中一种模式，之后在节点的配置中不能修改。

<figure>
  <img alt="条件判断_模式选择" src="https://github.com/nocobase/nocobase/assets/525658/2af1907a-686d-4ae5-a60e-602c038b3388" width="457">
</figure>

“‘是’则继续”的模式下，当条件判断的结果为“是”时，流程将继续执行后续节点，否则流程将终止，并以失败的状态提前退出。这种模式适合于不满足条件的情况下，流程不再继续的场景，例如使用“提交至工作流”表单按钮配置了提交订单的表单，但在订单对应商品库存不足的情况下，不继续生成订单，而是失败退出。

“‘是’和‘否’分别继续”的模式下，条件节点后续会产生两条分支流程，分别对应条件判断的结果为“是”和“否”时的流程，两条分支流程可以分别配置后续节点，在任意分支执行完毕后，再自动汇合到条件节点所在的上级分支，继续执行之后的节点。这种模式适合于满足条件和不满足条件的情况下，流程需要分别执行不同的操作的场景，例如查询某条数据是否存在，不存在的时候新增，存在的时候更新。

#### 节点配置

##### 运算引擎

目前支持三种引擎：

* **基础**：通过简单的双目计算和“与”、“或”分组，得到逻辑结果。
* **Math.js**：计算 [Math.js](https://mathjs.org/) 引擎支持的表达式得到逻辑结果。
* **Formula.js**：计算 [Formula.js](https://formulajs.info/) 引擎支持的表达式得到逻辑结果。

三种计算中均可以使用流程上下文的变量，用作计算的操作数。

#### 示例

TODO

### 并行分支

并行分支节点可以将流程分为多个分支，每个分支可以配置不同的节点，根据分支的模式不同，分支的执行方式也不同。在需要在同时执行多个操作的场景下，可以使用并行分支节点。

#### 基本使用

并行分支节点有三种模式，分别是“全部成功”、“任意成功”和“任意成功和失败”，创建并行分支节点后，可以在节点的配置中选择其中一种模式。

在流程中增加并行分支节点后，会默认增加两个子分支，同时也可以点击增加分支的按钮增加任意多个分支，每个分支都可以增加任意的节点，不需要的分支可以点击分支开始处的删除按钮删除。

<figure>
  <img alt="并行分支_分支管理" src="https://github.com/nocobase/nocobase/assets/525658/4cbd6c3a-3599-4284-9aff-438f1db0d81f" width="970"/>
</figure>

#### 节点配置

##### 分支模式

* **全部成功**：所有分支都执行成功，流程才会继续执行分支结束后的节点。否则任意分支提前终止，无论是失败、出错还是其他非成功状态，都导致整个并行分支节点以该状态提前终止，也称作“All 模式”。
* **任意成功**：任意分支执行成功，流程就会继续执行分支结束后的节点。除非所有分支都提前终止，无论是失败、出错还是其他非成功状态，才会导致整个并行分支节点以该状态提前终止，也称作“Any 模式”。
* **任意成功和失败**：任意分支执行成功后流程就会继续执行分支结束后的节点，但任意节点失败后，会导致整个并行以该状态提前终止，也称作“Race 模式”。

不论哪种模式，都会从左到右依次尝试执行每个分支，直到满足分支预设模式的相关条件后，继续执行后续节点或提前退出。

#### 示例

TODO

### 循环

循环相当编程语言中的 `for`/`while`/`forEach` 等语法结构，当需要一定次数或针对某个数据集合（数组）重复执行一些操作时，可以使用循环节点。

#### 基本使用

创建循环节点后，会生成一个循环内部的分支，可以在分支中增加任意多个节点，这些节点除了可以使用流程上下文的变量，还可以使用循环上下文的局部变量，例如循环集合中每次循环到的数据对象，或者是循环次数的索引（索引从 `0` 开始计数）。局部变量的作用域仅限于循环内部，如果有多层循环嵌套，内层循环的局部变量会覆盖外层循环的局部变量。

#### 节点配置

##### 循环对象

循环会以循环对象不同数据类型做不同的处理：

1.  **数组**：最常见的情况，通常是可以选择流程上下文的变量，比如查询节点的多条数据结果，或者预加载的对多关系数据。如果选择的是数组，循环节点会遍历数组中的每个元素，每次循环都会将当前元素赋值给循环上下文的局部变量。

2.  **数字**：当选择的变量是一个数字是，会以该数字为循环次数，局域变量中的循环次数的索引也即循环对象的值。

3.  **字符串**：当选择的变量是一个字符串时，会以该字符串的长度为循环次数，每次按索引处理字符串中的每一个字符。

4.  **其他**：其他类型的值（包括对象类型）都仅作为单次处理的循环对象，也只会循环一次，通常这种情况不需要使用循环。

除了选择变量，针对数字和字符串类型也可以直接输入常量，例如输入 `5`（数字类型），循环节点会循环 5 次，输入 `abc`（字符串类型），循环节点会循环 3 次，分别处理 `a`、`b`、`c` 三个字符。

#### 示例

TODO

### 延时

延时节点可以在流程中增加一个延时，延时结束后，可根据配置是继续执行延时结束后的节点或是提前终止流程。

#### 基本使用

通常配合并行分支节点一起使用，可以在其中一个分支中增加延时节点，以达到超时后相关处理的目的。例如并行分支中其中一个分支包含人工处理，另一个分支包含延时节点，当人工处理超时后，如果设置的是超时失败，则代表人工处理必须在限定时间内完成，如果设置的是超时继续，则代表到时间后可以忽略该人工处理。

#### 节点配置

<figure>
    <img alt="延时节点_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/8ff4d17f-99a3-43bd-bf51-b55cd83dd8ce" width="619" />
</figure>

##### 延时时间

延时时间可以填写一个数字，并选择时间单位，支持的时间单位有：秒、分钟、小时、天和周。

##### 到时状态

到时状态可以选择“通过并继续”和“失败并退出”，前者代表延时结束后，流程会继续执行延时结束后的节点，后者代表延时结束后，流程会以失败状态提前终止。

#### 示例

TODO

### 运算

运算节点虽然不对流程进行控制，但是流程中一种重要的功能，运算节点可以对一个表达式进行计算，运算结果会保存在对应节点的结果中，以供后续其他节点使用。是一种用于计算、处理和转换数据的工具，某种程度上，可以代替编程语言中对一个值计算函数调用并赋值给变量的功能。

#### 基本使用

表达式有两种类型：静态表达式和动态表达式，本文仅介绍静态表达式的用法，动态表达式的用法可以扩展阅读《表达式表》相关介绍。

#### 节点配置

<figure>
    <img alt="运算节点_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/a4d27149-d32d-4320-8426-5434ad0b84e1" width="707" />
</figure>

##### 运算引擎

运算引擎规定了表达式支持的语法，目前支持的运算引擎有 [Math.js](https://mathjs.org/) 和 [Formula.js](https://formulajs.info/)，引擎各自都内置了大量的常用函数和数据操作的方法，具体的用法可以参考其官方文档。需要注意的是，两者在数组下标访问上有所区别，Math.js 的索引是从 `1` 开始，而 Formula.js 是从 `0` 开始。

##### 表达式

表达式即一个运算公式的字符串表达，可以由变量、常量、运算符和支持的函数等组成。可以使用流程上下文的变量，例如运算节点的前置节点的结果，或者是循环的局部变量等。输入不符合语法的会在节点配置中提示错误，如果在具体执行时变量不存在或者类型不匹配，又或者使用了不存在的函数，运算节点会以出错的状态提前终止。

#### 示例

##### 计算订单总价

通常一个订单内可能有多个商品，每个商品的价格和数量都不同，订单的总价需要计算所有商品的价格和数量的乘积之和。可以在加载订单明细列表（对多关系数据集）之后使用运算节点来计算订单的总价：

<figure>
    <img alt="运算节点_示例_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/6a81347b-e5cd-4b16-8c55-ea62141ebba4" width="783" />
</figure>

其中 Formula.js 的 `SUMPRODUCT` 函数可以计算两个相同长度数组每行的乘积之和，加总就可以得到订单的总价。

## 数据表操作

主要针对 NocoBase 管理的数据表进行操作，包括常见的增删改查等。

### 新增数据

用于对某个数据表新增一行数据。

#### 基本使用

新增数据行的字段值可以使用流程上下文的变量，对关系字段的赋值可以直接引用上下文中的对应数据变量，可以是对象，也可以是外键的值。如果不使用变量，则需要手动填写外键的值，对多关系的多个外键值需要使用英文逗号分隔的形式。

#### 节点配置

<figure>
    <img alt="运算节点_示例_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/f16ebb35-44f2-4d11-845f-655d561d7083" width="793" />
</figure>

##### 数据表

选择要新增数据的数据表。

##### 字段值

针对数据表的字段进行赋值，可以使用流程上下文的变量，也可以手动填写静态值。

注：工作流中新增节点新增的数据不会自动处理“创建人”、“最后修改人”等用户数据，需要根据情况自行配置这两个字段的值。

##### 预加载关系数据

如果新增数据的字段中包含关系字段，且希望后续流程中使用相应的关系数据时，可以在预加载配置中勾选相应的关系字段，这样在新增数据完成后，会自动加载相应的关系数据一并储存在节点的结果数据中。

#### 示例

例如当“文章”表的数据变更时，需要自动新增一条“文章版本”数据，记录文章的变更历史，可以使用新增节点来实现：

<figure>
    <img alt="新增节点_示例_流程配置" src="https://github.com/nocobase/nocobase/assets/525658/c58526c9-b49b-4cca-a41a-5a02ea218d14" width="340" />
    <figcaption>流程配置</figcaption>
</figure>

<figure>
    <img alt="新增节点_示例_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/3aac7675-49b4-4854-8f94-5c72f238636f" width="792" />
    <figcaption>节点配置</figcaption>
</figure>

启用工作流后，当“文章”表的数据变更时，会自动新增一条“文章版本”数据，记录文章的变更历史。

### 更新数据

用于对某个数据表的满足条件的数据进行更新。

#### 基本使用

数据表和字段赋值部分与新增节点相同，更新节点的区别主要是增加了筛选条件，而且需要选择更新模式。另外，更新节点的结果会返回更新成功数据的行数，只在执行历史里可查看，不可作为变量在后续节点使用。

#### 节点配置

<figure>
    <img alt="更新节点_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/14734301-9c5a-4645-81e4-e591d0c2432a" width="614" />
</figure>

##### 数据表

选择要更新数据的数据表。

##### 更新模式

更新模式有“批量”和“逐条”的模式，批量模式下，不会再触发每条更新数据的数据表事件，而逐条更新的话会触发每条更新数据的数据表事件，但在大数据量下会有性能问题，需要谨慎使用。通常根据更新的目标数据和是否要触发其他工作流事件来选择，如果是根据主键更新单条数据的，建议使用逐条更新，如果是根据条件更新多条数据的，建议使用批量更新。

##### 筛选条件

与普通的数据表查询时的筛选条件类似，可以使用流程的上下文变量。

##### 字段值

与新增节点的字段赋值类似，可以使用流程上下文的变量，也可以手动填写静态值。

注：工作流中更新节点更新的数据不会自动处理“最后修改人”数据，需要根据情况自行配置这个字段的值。

#### 示例

例如当新增“文章”时，需要自动更新“文章分类”表的“文章数量”字段，可以使用更新节点来实现：

<figure>
    <img alt="更新节点_示例_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/bf230f38-7d0c-4d7e-b68f-a6c3834535d0" width="835" />
</figure>

当工作流触发后，会自动更新“文章分类”表的“文章数量”字段为当前文章数量 +1。

### 删除数据

用于对某个数据表的满足条件的数据进行删除。

#### 基本使用

删除节点的基本使用与更新节点类似，只是删除节点不需要字段赋值，只需要选择数据表和筛选条件即可。删除节点的结果会返回删除成功数据的行数，只在执行历史里可查看，不可作为变量在后续节点使用。

注：目前删除节点不支持逐条删除，均为批量删除，因此不会触发每条数据删除的其他事件。

#### 节点配置

<figure>
    <img alt="删除节点_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/5e1050ed-d3c2-47bb-a4aa-2b53530ef4cb" width="718" />
</figure>

##### 数据表

选择要删除数据的数据表。

##### 筛选条件

与普通的数据表查询时的筛选条件类似，可以使用流程的上下文变量。

#### 示例

例如定时清理已取消的无效历史订单数据，可以使用删除节点来实现：

<figure>
    <img alt="删除节点_示例_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/46022d53-641e-4e67-beb9-1f4ce29357f6" width="694" />
</figure>

工作流将定时触发，并执行删除所有已取消的无效历史订单数据。

### 查询数据

用于对某个数据表的满足条件的数据进行查询并获取数据记录。

#### 基本使用

可以配置查询单条数据或多条数据，查询结果可以作为变量在后续节点使用。当查询多条数据时，查询结果为一个数组。当查询结果为空时，可以选择是否继续执行后续节点。

#### 节点配置

<figure>
    <img alt="查询节点_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/78d2c6ad-6d39-4f92-a0c8-79e16677b641" width="979" />
</figure>

##### 数据表

选择要查询数据的数据表。

##### 查询模式

勾选“允许结果是多条数据”后，将会查询出满足条件的所有数据，否则只会查询出满足条件的第一条数据。

##### 筛选条件

与普通的数据表查询时的筛选条件类似，可以使用流程的上下文变量。

##### 排序

查询一条或多条数据时均可通过排序规则来控制需要的结果。例如查询最新的一条数据，可以通过“创建时间”字段降序排序。

##### 分页

当结果集可能会很大是，可以使用分页来控制查询结果的数量。例如查询最新的 10 条数据，可以通过“创建时间”字段降序排序，然后设置分页为 1 页 10 条数据。

##### 结果为空的处理

在单条结果模式下，没有符合条件的数据的话查询结果会是 `null`，多条结果的模式下是空数组（`[]`）。可以根据需要是否勾选“查询结果为空是，退出流程”，勾选后，如果查询结果为空，则不会执行后续节点，以失败的状态提前退出。

### 聚合查询

用于对某个数据表的满足条件的数据进行聚合函数查询，并返回对应的统计结果。常用于处理报表相关的统计数据。

#### 基本使用

实现上基于数据库的聚合函数，目前仅支持对一个数据表的单字段进行统计，统计结果的数值会保存在节点的结果中供后续其他节点使用。

#### 节点配置

<figure>
    <img alt="聚合查询节点_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/a7ae9b56-f774-4e7d-b9d3-c03be7806c82" width="671" />
</figure>

##### 聚合函数

支持 SQL 中的 `COUNT`、`SUM`、`AVG`、`MIN` 和 `MAX` 共 5 种聚合函数，选择其中一种对数据进行聚合查询。

##### 目标类型

聚合查询的目标可以通过两种模式选择，一种是直接选择目标数据表和其中的一个字段，另一种是通过流程上下文已有的数据对象，选择其对多的关系数据表及字段，进行聚合查询。

##### 去重

即 SQL 中的 `DISTINCT`，去重的字段与选择的数据表字段相同，暂时不支持两者选不同的字段。

##### 筛选条件

与普通的数据表查询时的筛选条件类似，可以使用流程的上下文变量。

#### 示例

聚合目标为“数据表数据”比较容易理解，这里以“统计新增文章后该文章分类的总文章数”为例，介绍聚合目标为“关联数据表数据”的用法。

首先，创建两张数据表：“文章”和“分类”，其中文章有一个多对一关系字段指向分类表，同时创建反向关系字段分类一对多文章：

| 字段名 | 类型 |
| --- | --- |
| 标题 | 单行文本 |
| 所属分类 | 多对一（分类） |

| 字段名 | 类型 |
| --- | --- |
| 分类名称 | 单行文本 |
| 包含文章 | 一对多（文章） |

接下来创建一个数据表事件触发的工作流，选择文章表新增数据后触发。

之后增加一个聚合查询节点，配置如下：

<figure>
    <img alt="聚合查询节点_示例_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/0006ab1a-16c2-4922-ac07-6be81abdbafa" width="674" />
</figure>

这样在工作流被触发后，聚合查询节点中将会统计新增文章的分类下所有文章的数量，并保存为节点的结果。

### SQL 操作

在一些特殊场景里，上面简单的数据表操作节点可能无法复杂的操作，则可以直接使用 SQL 节点，使数据库直接执行复杂的 SQL 语句进行数据操作。

#### 基本使用

与在应用外部直接连接数据库进行 SQL 操作的区别是，在工作流内可以使用流程上下文的变量，作为 SQL 语句中的部分参数。

注：目前 SQL 节点还不支持 `SELECT` 语句的结果作为节点结果使用，可能会在未来支持。

#### 节点配置

通过编辑框右上角的变量按钮插入需要的变量，会在执行前通过文本替换为对应变量的值：

<figure>
    <img alt="SQL节点_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/d8daacec-8fd6-40e8-a13e-ef6d910cf290" width="670" />
</figure>

## 人工处理

### 人工处理

## 外部调用

### HTTP 请求

当需要与另一个 web 系统进行交互时，可以使用 HTTP 请求节点。该节点在执行时会根据配置向对应的地址发出一个 HTTP 请求，可以携带 JSON 格式的数据，完成与外部系统的数据交互。

#### 基本使用

如果对 Postman 这类请求发送工具比较熟悉，那么可以很快掌握 HTTP 请求节点的用法。与这些工具不同的是，HTTP 请求节点中各项参数均可使用当前流程中的上下文变量，可以与当前系统的业务处理有机结合起来。

注：HTTP 请求节点暂不支持请求响应的结果进行使用，可能会在未来支持。

#### 节点配置

<figure>
    <img alt="HTTP请求节点_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/980457f0-9637-4479-a78f-a3973c894a15" width="680" />
</figure>

##### 请求方法

可选的 HTTP 请求方法：`GET`、`POST`、`PUT`、`PATCH` 和 `DELETE`。

##### 请求地址

HTTP 服务的 URL，需要包含协议部分（`http://` 或 `https://`），推荐使用 `https://`。

##### 请求头配置

请求 Header 部分的键值对，相关值可以使用流程上下文的变量。

注：对 `Content-Type` 请求头，目前仅支持 `application/json` 的格式，且已默认内置，无需填写，覆盖无效。

##### 请求参数

请求 query 部分的键值对，相关值可以使用流程上下文的变量。

##### 请求体

请求的 Body 部分，目前仅支持标准的 JSON 格式，可以通过文本编辑框右上角的变量按钮插入流程上下文中的变量。

注：变量必须在 JSON 的字符串中使用。

##### 超时设置

当请求长时间未响应时，通过超时设置取消该请求的执行。请求超时后会以失败状态提前终止当前流程。

##### 忽略失败

请求节点会以标准 HTTP 状态码的 `200`~`299` 之间的状态认为是成功状态，其他的均认为是失败。如勾选了“忽略失败的请求并继续工作流”选项，则当请求失败后仍继续执行后续的其他流程节点。

#### 示例

例如我们可以使用请求节点来对接云平台发送通知短信，以阿里云发送短信接口为例配置如下（相关参数需自行查阅文档适配）：

<figure>
    <img alt="HTTP请求节点_示例_节点配置" src="https://github.com/nocobase/nocobase/assets/525658/980457f0-9637-4479-a78f-a3973c894a15" width="680" />
</figure>

工作流触发该节点执行时会以配置的内容调用阿里云的短信接口，请求成功的话将通过短信云服务发送一条短信。
