# 触发器

触发器是工作流的执行入口，当应用运行过程中满足触发器条件的事件产生时，工作流将会被触发执行。触发器的类型也就是工作流的类型，在创建工作流时选择，创建后不可修改。目前支持的触发器类型如下：

* 表单事件
* 数据表事件
* 定时任务

创建工作流以后，在工作流查看页面中，触发器会以入口节点的样式显示在流程的开始位置，点击该卡片即可打开配置弹窗。根据触发器的类型不同，可以配置触发器的相关条件。

<figure>
  <img alt="触发器_入口节点" src="https://github.com/nocobase/nocobase/assets/525658/83e38fef-db0b-41d9-a2c1-afecf7f00ca1" width="287">
</figure>

## 表单事件

表单提交事件针对 UI 界面中新增和更新数据的表单操作按钮，在表单中点击对应已绑定工作流的按钮后，将触发对应绑定的工作流执行。例如对某个活动发起报名的表单，报名（表单提交）成功后触发相应的流程处理。

### 基本使用

针对“提交”按钮（含“保存数据”按钮）配置的工作流，将在用户提交对应表单且数据操作完成后被触发。

<figure>
  <img alt="表单事件_提交按钮" src="https://github.com/nocobase/nocobase/assets/525658/d321f964-859f-4d72-86a6-57301fb471fc" width="510">
</figure>

针对自定义的“提交至工作流”按钮配置的工作流，将在用户点击对应按钮时，直接将已配置的表单数据提交到对应工作流进行处理。

<figure>
  <img alt="表单事件_提交至工作流按钮" src="https://github.com/nocobase/nocobase/assets/525658/2b4a37bc-ca5c-4bea-b864-1b59bc17df32" width="504">
</figure>

从按钮配置的菜单中选择“绑定工作流”，即可打开绑定配置弹窗。弹窗中可以配置任意多个要触发的工作流，如果一个都不配置，则代表无需触发。针对每一个工作流，需要先限定触发的数据是整个表单的数据还是表单中的某个关系字段的数据，之后再根据所选的数据模型对应的数据表，选择已配置了匹配该表模型的表单工作流。

<figure>
  <img alt="表单事件_绑定工作流配置_上下文选择" src="https://github.com/nocobase/nocobase/assets/525658/d0e410c9-ab98-43f7-8431-1fe4c8731f01" width="589">
</figure>

<figure>
  <img alt="表单事件_绑定工作流配置_工作流选择" src="https://github.com/nocobase/nocobase/assets/525658/ceb114ba-5aa7-4f00-971c-6426e5bd2390" width="581">
</figure>

### 相关提示

#### 与数据表事件的区别

表单提交事件与数据表事件不同的地方在于，表单事件只在配置了绑定工作流的按钮点击后才触发，而如果针对一个数据表有多个不同的新增或更新表单（如针对不同角色的不同界面上），未配置绑定工作流按钮的表单提交时，不会触发。而如果配置了针对数据表事件的工作流，则在任意对应表单提交后，都会触发该工作流。

#### “提交至工作流”按钮的区别

而且针对“提交至工作流”的自定义按钮点击时，提交的数据不会被直接保存到数据表中，而是交给对应的工作流作为上下文数据，由已定义的流程进行特定的处理。上下文中除了表单数据，还会包含提交表单的“当前用户”对象，可以在后续流程中使用。后续处理过程中可以根据提交数据的条件，选择保存到对应数据表，也可以不保存。这种直接交给工作流的表单提交事件，在一定程度上，可以配置为提交申请和审批场景中的流程。

<!-- “提交至工作流”的表单数据还有一点区别，由于提交的数据不会先保存在数据库中，所以如果要用到部分关系字段的数据，必须在表单中配置好关系字段，且保证提交的数据中已经包含对应字段的值，然后也需要在工作流配置中勾选相应的关系字段，否则在节点中将无法获取到关系字段的数据。 -->

### 示例

普通的“提交”触发与数据表事件类似，这里主要针对“提交至工作流”的方式进行演示。

假设一个“报销申请”的场景，我们需要在员工提交费用报销后，进行额度的自动审核和超出额度的人工审核，审核成功的才通过申请，并在之后交由财务处理。

首先，我们可以先创建一张“费用报销”数据表，有以下字段：

* 项目名称：单行文本
* 申请人：多对一（用户）
* 金额：数字
* 状态：单选（“审核通过”、“处理完成”）

之后先创建一个“表单事件”类型的工作流，并且把触发器中的数据表模型配置为“费用报销”表：

<figure>
  <img alt="配置表单事件工作流的数据模型" src="https://github.com/nocobase/nocobase/assets/525658/e8665221-b7d3-40a0-ab6e-de7a77cb47d0" width="478">
</figure>

将工作流设置为启用状态后，流程的具体处理节点稍后再回来配置。

然后我们在界面上创建“费用报销”数据表的表格区块，并且在工具栏增加一个“添加”按钮，配置对应的表单字段。这里我们不使用默认的“提交”按钮，而是移除后重新添加一个“提交至工作流”的按钮：

<figure>
  <img alt="配置提交表单" src="https://github.com/nocobase/nocobase/assets/525658/c339aaa5-d116-4f05-b911-241a4e414ea2" width="510">
</figure>

并打开按钮的“绑定工作流”配置对话框，选择整个表单数据作为上下文，以及工作流为我们之前创建的工作流：

<figure>
  <img alt="配置绑定工作流" src="https://github.com/nocobase/nocobase/assets/525658/d0e410c9-ab98-43f7-8431-1fe4c8731f01" width="589">
</figure>

表单配置完成后，再回到工作流的逻辑编排。比如我们需要金额大于 500 元时要求管理员进行人工审核，否则直接通过，审核通过后才创建报销记录，并由财务进一步处理（略）。

<figure>
  <img alt="配置绑定工作流" src="https://github.com/nocobase/nocobase/assets/525658/d68c9275-203d-4794-b503-0adc22f7ab37" width="597">
</figure>

忽略后续财务的处理的话，这样就完成了申请报销流程的配置，当员工填写报销申请并提交后，会触发对应的工作流，如果费用金额小于 500，会自动创建记录并等待财务进一步处理，否则会由主管审核，审核通过后也是一样创建记录并交给财务处理。

该示例的流程也可以配置在普通“提交”按钮上，可以根据具体的业务场景决定是否需要先创建记录再执行后续的流程。

## 数据表事件

数据表事件类型的触发器将监听数据表的增删改查事件，当发生对该表的数据操作且满足配置的条件时，触发对应工作流。例如新增订单后扣减商品的库存，新增一条评论后等待人工审核等场景。

### 基本使用

数据表的变动有几种情况：

1. 新增数据后。
2. 更新数据后。
3. 新增或更新数据后。
4. 删除数据后。

<figure>
  <img alt="数据表事件_触发时机选择" src="https://github.com/nocobase/nocobase/assets/525658/413815a7-53ca-4535-9aaf-0633192a3133" width="371">
</figure>

可以根据业务的不同需要选择触发的时机。当选择变动情况中包含更新数据表的情况时，还可以对发生变动的字段进行限定，只有选中字段发生变动时，才满足触发条件，不选择则代表所有字段发生变动都可以触发。

<figure>
  <img alt="数据表事件_发生变动的字段选择" src="https://github.com/nocobase/nocobase/assets/525658/b44537a4-785a-4eef-8dae-8542630518e5" width="671">
</figure>

更细节地，可以对触发的数据行的各个字段配置条件规则，当其中的字段满足相应条件，才进行触发。

<figure>
  <img alt="数据表事件_配置数据满足的条件" src="https://github.com/nocobase/nocobase/assets/525658/7905c8fe-7b98-47bc-be33-2524af32c958" width="676">
</figure>

数据表事件触发后会在执行计划中注入产生事件的数据行作为触发上下文数据，以供后续流程中的节点作为变量调用。但当后续节点中希望使用该数据的关系字段时，需要先配置对关系数据的预加载，选中的关系数据将会在触发后一并注入到上下文中，且可被按层级进行选择使用。

### 相关提示

#### 暂不支持批量数据操作触发

数据表事件事件暂不支持批量数据操作的触发，例如新增文章数据时同时新增的该文章的多个标签数据（对多关系数据），将仅能触发对文章新增的工作流，而同时新增的多个标签将不会触发新增标签的工作流。多对多关系数据的关联和新增时，也不会触发中间表的工作流。

#### 非应用内的数据操作不会触发

另外，通过 HTTP API 调用应用接口对数据表的操作也可以触发相应事件，但如果不通过 NodoBase 应用，而是直接通过数据库操作产生的数据变动，就无法触发相应事件。比如数据库中本身的触发器不会与应用中的工作流产生关联。

### 示例

以新增一个订单后计算总价并扣减库存的场景举例。

首先，我们创建商品表和订单表，数据模型如下：

| 字段名称 | 字段类型 |
| --- | --- |
| 商品名称 | 单行文本 |
| 价格 | 数字 |
| 库存 | 整数 |

| 字段名称 | 字段类型 |
| --- | --- |
| 订单号 | 自动编号 |
| 订单商品 | 多对一（商品） |
| 订单总价 | 数字 |

并添加基础的商品数据：

| 商品名称 | 价格 | 库存 |
| --- | --- | --- |
| iPhone 14 Pro | 7999 | 10 |
| iPhone 13 Pro | 5999 | 0 |

然后创建一个基于订单数据表事件的工作流：

<figure>
  <img alt="数据表事件_示例_新增订单触发" src="https://github.com/nocobase/nocobase/assets/525658/057733a5-db79-4d57-b2d1-84cad4af5191" width="680">
</figure>

其中的几个配置项：

* 数据表：选择“订单”表。
* 触发时机：选择“新增数据后”触发。
* 触发条件：留空。
* 预加载关系数据：勾选“商品”。

之后根据流程的逻辑配置其他节点，检查商品库存是否大于 0，大于 0 的扣减库存，否则订单无效删除订单：

<figure>
  <img alt="数据表事件_示例_新增订单流程编排" src="https://github.com/nocobase/nocobase/assets/525658/887d4af7-a638-47d0-81ae-aa9b4a29c4b9" width="731">
</figure>

节点的配置会在具体类型的介绍文档中详细说明。

启用该工作流，并通过界面新增订单来测试。对“iPhone 14 Pro”下单后，对应商品的库存会扣减为 9，而如果对“iPhone 13 Pro”下单，由于库存不足，订单将被删除。

<figure>
  <img alt="数据表事件_示例_新增订单执行结果" src="https://github.com/nocobase/nocobase/assets/525658/7a8d2cdb-8038-4276-84ed-cf8a2177e48d" width="902">
</figure>

## 定时任务

定时任务是以时间为触发条件的事件，分为两种模式：

* 自定义时间：常规类似 cron 的按系统时间计划触发
* 数据表时间字段：按数据表中时间字段的值到时触发

系统运行到满足所配置的触发条件的时间点（精度到秒）时，会触发相应的工作流。

### 基本使用

#### 自定义时间模式

针对常规的模式，首先需要配置开始时间为任意时间点（精度到秒）。开始时间可以配置为未来的时间，也可以配置为过去的时间。当配置为过去的时间时，会根据配置的重复条件检查是否到时，如果没有配置重复条件，开始时间如果是过去的时间，则工作流不再会被触发。

重复规则有两种配置方式：

* 按间隔时间：开始时间后每固定间隔时间触发，如每一小时，每 30 分钟等。
* 高级模式：即按 cron 规则，可配置为到达固定规则日期时间的周期。

配置了重复规则后，还可以配置结束条件，可以通过固定时间点结束，也可以通过已执行过的次数限制。

#### 数据表时间字段模式

通过数据表的时间字段来确定开始时间，是一种将普通定时任务和数据表时间字段结合的触发模式，使用这个模式可以简化一些特定流程的中的节点，从配置上也更加直观。例如，需要将超时未支付的订单修改为已取消的状态，可以仅配置一个数据表时间字段模式的定时任务，选择开始时间为订单创建后 30 分钟，

### 相关提示

#### 未启动或停机状态下的定时任务

如果配置的时间条件满足时，但整个 NocoBase 应用服务处在未启动或停机状态，则对应时间点应该触发的定时任务会被错过，且在服务重新启动后，已经错过的任务不会再被触发。所以在使用时可能需要考虑对应情况的处理，或候补措施。

#### 重复次数

配置了结束条件中的按重复次数时，计算的是同一个工作流所有版本执行过的总次数，例如一个定时任务在版本 1 的时候执行过 10 次，如果重复次数也设置了 10 次，该工作流将不再会被触发，即使复制到新版本，也不会被触发，除非将重复次数修改为大于 10 的数字。但如果是复制为新的工作流，已执行的次数将会重新从 0 开始计算，不修改相关配置的情况下，新的工作流将可以再被触发 10 次。

#### 重复规则中间隔时间与高级模式的区别

重复规则中的间隔时间是相对于上一次触发（开始时间）的时间点，而高级模式是按固定的时间点触发，例如，配置了每 30 分钟触发一次，如果上一次触发是 2021-09-01 12:01:23，那么下一次触发时间是 2021-09-01 12:31:23。而高级模式即 cron 模式，配置的规则均为固定的时间点触发，例如，可以配置在每小时的 01 分和 31 分触发。

### 示例

假设每分钟检查创建后超过 30 分钟未完成支付的订单，并自动修改为已取消状态。分别使用两种模式来实现。

#### 自定义时间模式

创建一个基于定时任务的工作流，触发器配置中选择“自定义时间”模式，开始时间选择任意不晚于当前时间的时间点，重复规则选择“每分钟”，结束条件留空：

<figure>
    <img alt="定时任务_触发器配置_自定义时间模式" src="https://github.com/nocobase/nocobase/assets/525658/3d96cb1e-472f-4b6b-abfe-3deb783bdc4a" width="505" />
</figure>

之后根据流程的逻辑配置其他节点，计算出 30 分钟，如果超时未支付则修改为已取消状态：

<figure>
    <img alt="定时任务_触发器配置_自定义时间模式" src="https://github.com/nocobase/nocobase/assets/525658/9817eb0b-951b-4954-b397-2eb6b2d33cec" width="468" />
</figure>

工作流启用后，从开始时间起每分钟会触发一次，计算 30 分钟前的时间，用于更新创建时间早于该时间点的订单状态为取消。

#### 数据表时间字段模式

创建一个基于定时任务的工作流，触发器配置中选择“数据表时间字段”模式，数据表选择“订单”表，开始时间选择订单的创建时间之后 30 分钟，重复规则选择“不重复”：

<figure>
    <img alt="定时任务_触发器配置_数据表时间字段模式_触发器" src="https://github.com/nocobase/nocobase/assets/525658/6caeb9bd-175a-4e65-be93-a376cde7ec53" width="709" />
</figure>

之后根据流程的逻辑配置其他节点，更新 ID 为触发数据 ID 且状态是“未支付”的订单为取消状态：

<figure>
    <img alt="定时任务_触发器配置_数据表时间字段模式_更新节点" src="https://github.com/nocobase/nocobase/assets/525658/887ca197-a973-4c0c-9e52-b26ca1b54bfc" width="788" />
</figure>

与自定义时间模式不同的是，这里不需要计算 30 分钟前的时间，因为工作流触发数据上下文中即包含对应符合时间条件的数据行，所以可以直接更新对应订单的状态。
