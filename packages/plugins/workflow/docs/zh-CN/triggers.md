# 触发器

触发器是工作流的执行入口，当应用运行过程中满足触发器条件的事件产生时，工作流将会被触发执行。触发器的类型也就是工作流的类型，在创建工作流时选择，创建后不可修改。目前支持的触发器类型如下：

* 表单事件
* 数据表事件
* 定时任务

创建工作流以后，在工作流查看页面中，触发器会以入口节点的样式显示在流程的开始位置，点击该卡片即可打开配置弹窗。根据触发器的类型不同，可以配置触发器的相关条件。

<figure>
  <img alt="触发器_入口节点" src="https://github.com/nocobase/nocobase/assets/525658/c8d99091-8160-44af-8f09-98d01f4c0d74" width="410">
</figure>

## 表单事件

表单提交事件针对 UI 界面中新增和更新数据的表单操作按钮，在表单中点击对应已绑定工作流的按钮后，将触发对应绑定的工作流执行。例如对某个活动发起报名的表单，报名（表单提交）成功后触发相应的流程处理。

### 基本使用

针对“提交”按钮（含“保存数据”按钮）配置的工作流，将在用户提交对应表单且数据操作完成后被触发。

<figure>
  <img alt="表单事件_提交按钮" src="https://github.com/nocobase/nocobase/assets/525658/60fa8e45-0b1a-4d5a-b1ec-c0279458b27d" width="508">
</figure>

针对自定义的“提交至工作流”按钮配置的工作流，将在用户点击对应按钮时，直接将已配置的表单数据提交到对应工作流进行处理。

<figure>
  <img alt="表单事件_提交至工作流按钮" src="https://github.com/nocobase/nocobase/assets/525658/f726a8d8-b866-469f-989a-8623e8f34f58" width="613">
</figure>

从按钮配置的菜单中选择“绑定工作流”，即可打开绑定配置弹窗。弹窗中可以配置任意多个要触发的工作流，如果一个都不配置，则代表无需触发。针对每一个工作流，需要先限定触发的数据是整个表单的数据还是表单中的某个关系字段的数据，之后再根据所选的数据模型对应的数据表，选择已配置了匹配该表模型的表单工作流。

<figure>
  <img alt="表单事件_绑定工作流配置_上下文选择" src="https://github.com/nocobase/nocobase/assets/525658/d0561e6c-8931-496c-bc62-8cac5096ce9b" width="594">
</figure>

<figure>
  <img alt="表单事件_绑定工作流配置_工作流选择" src="https://github.com/nocobase/nocobase/assets/525658/c804950e-d9ae-43ee-b9c1-c0c12cc3dc14" width="596">
</figure>

### 相关提示

表单提交事件与数据表事件不同的地方在于，表单事件只在配置了绑定工作流的按钮点击后才触发，而如果针对一个数据表有多个不同的新增或更新表单（如针对不同角色的不同界面上），未配置绑定工作流按钮的表单提交时，不会触发。而如果配置了针对数据表事件的工作流，则在任意对应表单提交后，都会触发该工作流。

而且针对“提交至工作流”的自定义按钮点击时，提交的数据不会被直接保存到数据表中，而是交给对应的工作流作为上下文数据，由已定义的流程进行特定的处理。处理过程中可以根据提交数据的条件，选择保存到对应数据表，也可以不保存。这种直接交给工作流的表单提交事件，在一定程度上，可以配置为提交申请和审批场景中的流程。

### 示例

## 数据表事件

数据表事件类型的触发器将监听数据表的增删改查事件，当发生对该表的数据操作且满足配置的条件时，触发对应工作流。例如新增订单后扣减商品的库存，新增一条评论后等待人工审核等场景。

### 基本使用

数据表的变动有几种情况：

1. 新增数据后。
2. 更新数据后。
3. 新增或更新数据后。
4. 删除数据后。

<figure>
  <img alt="数据表事件_触发时机选择" src="https://github.com/nocobase/nocobase/assets/525658/413815a7-53ca-4535-9aaf-0633192a3133" width="371">
</figure>

可以根据业务的不同需要选择触发的时机。当选择变动情况中包含更新数据表的情况时，还可以对发生变动的字段进行限定，只有选中字段发生变动时，才满足触发条件，不选择则代表所有字段发生变动都可以触发。

<figure>
  <img alt="数据表事件_发生变动的字段选择" src="https://github.com/nocobase/nocobase/assets/525658/b44537a4-785a-4eef-8dae-8542630518e5" width="671">
</figure>

更细节地，可以对触发的数据行的各个字段配置条件规则，当其中的字段满足相应条件，才进行触发。

<figure>
  <img alt="数据表事件_配置数据满足的条件" src="https://github.com/nocobase/nocobase/assets/525658/7905c8fe-7b98-47bc-be33-2524af32c958" width="676">
</figure>

数据表事件触发后会在执行计划中注入产生事件的数据行作为触发上下文数据，以供后续流程中的节点作为变量调用。但当后续节点中希望使用该数据的关系字段时，需要先配置对关系数据的预加载，选中的关系数据将会在触发后一并注入到上下文中，且可被按层级进行选择使用。

### 相关提示

数据表事件事件暂不支持批量数据操作的触发，例如新增文章数据时同时新增的该文章的多个标签数据（对多关系数据），将仅能触发对文章新增的工作流，而同时新增的多个标签将不会触发新增标签的工作流。多对多关系数据的关联和新增时，也不会触发中间表的工作流。

另外，通过 HTTP API 调用应用接口对数据表的操作也可以触发相应事件，但如果不通过 NodoBase 应用，而是直接通过数据库操作产生的数据变动，就无法触发相应事件。

### 示例

## 定时任务

定时任务是以时间为触发条件的事件，分为两种模式：

* 自定义时间：常规类似 cron 的按系统时间计划触发
* 数据表时间字段：按数据表中时间字段的值到时触发

系统运行到满足所配置的触发条件的时间点（精度到秒）时，会触发相应的工作流。

### 基本使用

#### 自定义时间模式

针对常规的模式，首先需要配置开始时间为任意时间点（精度到秒）。开始时间可以配置为未来的时间，也可以配置为过去的时间。当配置为过去的时间时，会根据配置的重复条件检查是否到时，如果没有配置重复条件，开始时间如果是过去的时间，则工作流不再会被触发。

重复规则有两种配置方式：

* 按间隔时间：开始时间后每固定间隔时间触发，如每一小时，每 30 分钟等。
* 高级模式：即按 cron 规则，可配置为到达固定规则的日期时间周期。

配置了重复规则后，还可以配置结束条件，可以通过固定时间点结束，也可以通过已执行过的次数限制。

#### 数据表时间字段模式

通过数据表的时间字段来确定开始时间，是一种将普通定时任务和数据表时间字段结合的触发模式，使用这个模式可以简化一些特定流程的中的节点，从配置上也更加直观。例如，需要将超时未支付的订单修改为已取消的状态，可以仅配置一个数据表时间字段模式的定时任务，选择开始时间为订单创建后 30 分钟，

### 相关提示

如果配置的时间条件满足时，但整个 NocoBase 应用服务处在未启动或停机状态，则对应时间点应该触发的定时任务会被错过，且在服务重新启动后，已经错过的任务不会再被触发。所以在使用时可能需要考虑对应情况的处理，或候补措施。

配置了结束条件中的按重复次数时，计算的是同一个工作流所有版本执行过的总次数，例如一个定时任务在版本 1 的时候执行过 10 次，如果重复次数也设置了 10 次，该工作流将不再会被触发，即使复制到新版本，也不会被触发，除非将重复次数修改为大于 10 的数字。但如果是复制为新的工作流，已执行的次数将会重新从 0 开始计算，不修改相关配置的情况下，新的工作流将可以再被触发 10 次。

### 示例
